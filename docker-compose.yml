version: "3.6"

services:
  postgres:
    build:
      context: ./postgres
    command: postgres -c 'port=5001' -c 'temp_buffers=200MB' -c 'work_mem=200MB'
    environment:
      - PGPORT=5001
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5001:5001"
    volumes:
      - postgresdata:/var/lib/postgresql/data
      - ./database_schema:/database_schema
      - ./scratch:/h5ad_store

  postgraphile:
    build:
      context: ./postgraphile
    command: >-
      --connection postgres://postgres:postgres@postgres:5001/postgres
      --schema public
      --watch
      --retry-on-init-fail
      --enable-query-batching
      --show-error-stack=json --extended-errors hint,detail,errcode
      --simple-collections only
      --no-setof-functions-contain-nulls
      --dynamic-json
      --append-plugins @graphile-contrib/pg-simplify-inflector,postgraphile-plugin-connection-filter
      --port 5000
      --graphql "/postgraphile/"
      --graphiql "/postgraphile/graphiql" --enhance-graphiql --allow-explain
    ports:
      - "5000:5000"

  client:
    build:
      context: ./client
    ports:
      - "5002:5002"

volumes:
  postgresdata:
